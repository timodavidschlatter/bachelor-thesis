variables:
    PROJ_LOC: '.\eBauGISTriage\BUDSharedCore'
#Stages  
stages:
  - build
  - publish

#Jobs
create_nuget:
  stage: build
  #only:
  #  - tags  # the build process will only be started by git tag commits
  script: |
    cd "$env:PROJ_LOC"
    & "$env:DOTNET_PATH" restore
    $versionStr = "$env:CI_COMMIT_TAG.$env:CI_PIPELINE_IID"
    Write-Host "Version: $versionStr" -ForegroundColor DarkGreen
    mkdir "$env:NUGETOUTPUT"
    & "$env:DOTNET_PATH" pack BUDSharedCore.csproj --output "$env:NUGETOUTPUT" --configuration=Debug --include-symbols --include-source -p:SymbolPackageFormat=snupkg -p:PackageVersion=$env:CI_COMMIT_TAG -p:AssemblyVersion=$versionStr -p:FileVersion=$versionStr
  artifacts:
    paths:
      - $env:PROJ_LOC\$env:NUGETOUTPUT\*.nupkg
      - $env:PROJ_LOC\$env:NUGETOUTPUT\*.snupkg
    expire_in: 2 days

publish_nuget:
  stage: publish
  only:
    - tags  # the build process will only be started by git tag commits
  script: |
    $path = Join-Path -Path "$env:PROJ_LOC" -ChildPath "$env:NUGETOUTPUT"
    cd "$path"
    & "$env:DOTNET_PATH" nuget push *.nupkg --source $env:BAGETSERVER --api-key $env:BAGETAPIKEY

